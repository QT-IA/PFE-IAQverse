<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>IAQverse</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
</head>
<body>
  <header>
    <h1>Dashboard</h1>
    <button class="info-btn" onclick="openModal()">
      <img src="/assets/icons/info.png">
    </button>

    <div id="infoModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h2>À propos de cette page</h2>
      <p>Cette interface Dashboard vous permet de visualiser l'évolution des composants principaux de la qualité de l'air.</p>
      <ul>
        <li>Évolution du CO₂</li>
        <li>Concentration de PM2.5</li>
        <li>Température & Humidité</li>
        <li>Concentration de TVOC</li>
      </ul>
    </div>
    </div>
  </header>

  <script>
    function openModal() {
      document.getElementById("infoModal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("infoModal").style.display = "none";
    }

    window.onclick = function(event) {
      const modal = document.getElementById("infoModal");
      if (event.target === modal) {
        modal.style.display = "none";
      }
    }
  </script>

  <div class="tabs-container">
    <div class="location-tabs" id="location-tabs">
      <!-- Les onglets des enseignes seront générés dynamiquement ici -->
    </div>
    <div class="room-tabs" id="room-tabs">
      <!-- Les onglets des pièces seront générés dynamiquement ici -->
    </div>
  </div>

  <main class="grid">
    <div class="chart-box" id="co2-chart"></div>
    <div class="chart-box" id="pm25-chart"></div>
    <div class="chart-box" id="comfort-chart"></div>
    <div class="chart-box" id="tvoc-chart"></div>
  </main>

  <footer class="nav-bar">
  <div class="nav-left">
    <a href="#" onclick="return false;" class="active-page">
      <img src="/assets/icons/home.png">
    </a>
    <a href="digital-twin.html">
      <img src="/assets/icons/digital-twin.png">
    </a>
  </div>

  <div class="nav-center">
    <span class="brand">IAQverse</span>
  </div>

  <div class="nav-right">
    <a href="settings.html">
      <img src="/assets/icons/settings.png">
    </a>
  </div>
</footer>

<script>
  let config = null;
  let activeEnseigne = null;

  async function loadEnseignes() {
    try {
      // Essayer d'abord l'API du backend
      const response = await fetch('http://localhost:8000/config');
      if (response.ok) {
        config = await response.json();
      } else {
        // Sinon essayer de charger le fichier statique
        const candidates = ['/assets/config.json', '../assets/config.json', 'assets/config.json'];
        for (const path of candidates) {
          try {
            const r = await fetch(path, {cache: 'no-store'});
            if (!r.ok) continue;
            config = await r.json();
            break;
          } catch (e) {
            continue;
          }
        }
      }

      if (!config || !config.lieux || !config.lieux.enseignes) {
        console.error('Pas d\'enseignes trouvées dans la configuration');
        return;
      }

      renderLocationTabs();
      
      // Activer la première enseigne par défaut
      if (config.lieux.enseignes.length > 0) {
        const defaultEnseigne = config.lieux.enseignes.find(e => e.id === config.lieux.active) || config.lieux.enseignes[0];
        switchEnseigne(defaultEnseigne.id);
      }
    } catch (error) {
      console.error('Erreur lors du chargement des enseignes:', error);
    }
  }

  function renderLocationTabs() {
    const tabsContainer = document.getElementById('location-tabs');
    tabsContainer.innerHTML = config.lieux.enseignes.map(enseigne => `
      <div class="location-tab${enseigne.id === activeEnseigne ? ' active' : ''}" 
            onclick="switchEnseigne('${enseigne.id}')"
            data-id="${enseigne.id}">
        <img src="/assets/icons/building.png" alt="Enseigne">
        ${escapeHtml(enseigne.nom)}
      </div>
    `).join('');
  }

  let activeRoom = null;

  function renderRoomTabs(enseigneId) {
    const roomTabs = document.getElementById('room-tabs');
    const enseigne = config.lieux.enseignes.find(e => e.id === enseigneId);
    
    if (!enseigne || !Array.isArray(enseigne.pieces)) {
      roomTabs.innerHTML = '<div class="room-tab">Aucune pièce</div>';
      return;
    }

    roomTabs.innerHTML = enseigne.pieces.map(piece => `
      <div class="room-tab${piece.id === activeRoom ? ' active' : ''}" 
            onclick="switchRoom('${piece.id}')"
            data-id="${piece.id}">
        <img src="/assets/icons/${piece.type || 'room'}.png" alt="${piece.type || 'Pièce'}">
        ${escapeHtml(piece.nom)}
      </div>
    `).join('');

    // Si aucune pièce n'est active, activer la première
    if (!activeRoom && enseigne.pieces.length > 0) {
      switchRoom(enseigne.pieces[0].id);
    }
  }

  function switchRoom(roomId) {
    activeRoom = roomId;
    
    // Mettre à jour l'apparence des onglets
    document.querySelectorAll('.room-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.id === roomId);
    });

    // Mettre à jour les graphiques avec les données de la pièce sélectionnée
    updateCharts(activeEnseigne, roomId);
  }

  function switchEnseigne(enseigneId) {
    activeEnseigne = enseigneId;
    activeRoom = null; // Réinitialiser la pièce active
    
    // Mettre à jour l'apparence des onglets d'enseignes
    document.querySelectorAll('.location-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.id === enseigneId);
    });

    // Mettre à jour les onglets des pièces pour l'enseigne sélectionnée
    renderRoomTabs(enseigneId);
  }

  function escapeHtml(s) {
    if (s === undefined || s === null) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // Charger les enseignes au démarrage
  document.addEventListener('DOMContentLoaded', loadEnseignes);

  function updateCharts(enseigneId, salleId) {
  // Cherche les objets correspondants dans la configuration
  const enseigne = config.lieux.enseignes.find(e => e.id === enseigneId);
  const salle = enseigne?.pieces?.find(p => p.id === salleId);

  // ⚙️ Utilise les noms (Maison, Salon) pour l'API
  currentEnseigne = enseigne?.nom || enseigneId;
  currentSalle = salle?.nom || salleId;

  // Recharge les données et met à jour les graphiques
  if (typeof window.resetCharts === 'function') {
    window.resetCharts();
  }
  fetchAndUpdate();
}

</script>
<script src="charts.js"></script>
</body>
</html>